#!/bin/bash

# <bitbar.title>backups helper</bitbar.title>
# <bitbar.version>v1.0</bitbar.version>
set -e

export PATH=/usr/local/bin:$PATH

LOGO="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"

LOGO_RUNNING="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"

BACKUPS_FILE="/tmp/backups.json"

function readBackupFile() {
  [ -f $BACKUPS_FILE ] && cat $BACKUPS_FILE || echo "{}"
}

# status: done | running | error | unknown
function status() {
  type=$1

  readBackupFile | jq '.'$type' // {}' | jq -r '.status // "unknown"'
}

function lastUpdate() {
  type=$1

  readBackupFile | jq '.'$type' // {}' | jq -r '.lastUpdate // ""'
}

function lastUpdateReadable() {
  type=$1

  lastUpdateDate=$(lastUpdate $type)

  if [ -z "$lastUpdateDate" ]; then
    echo "unknown"
  else
    date -r $lastUpdateDate
  fi
}

if [ "$(status documents)" = "running" ] || [ "$(status mails)" = "running" ] || [ "$(status vdirs)" = "running" ]; then
  echo "| templateImage=$LOGO_RUNNING"
else
  echo "| templateImage=$LOGO"
fi

echo "---"
echo "Backups"
echo "Documents: $(status documents) - $(lastUpdateReadable documents) | color=#333"
echo "Mails: $(status mails) - $(lastUpdateReadable mails) | color=#333"
echo "Vdirs: $(status vdirs) - $(lastUpdateReadable vdirs) | color=#333"
